-- Main products query
-- Store this as getProductsWithMetadata
SELECT 
  p.ID, 
  p.post_title, 
  p.post_content,
  p.post_excerpt,
  p.post_name,
  p.post_date,
  p.post_modified,
  pm.meta_key, 
  pm.meta_value,
  COUNT(wbi.bundle_id) as is_bundle,
  img.guid as image_url
FROM wp_posts p
LEFT JOIN wp_postmeta pm ON p.ID = pm.post_id
LEFT JOIN wp_woocommerce_bundled_items wbi ON p.ID = wbi.bundle_id
LEFT JOIN wp_postmeta thumb ON p.ID = thumb.post_id AND thumb.meta_key = '_thumbnail_id'
LEFT JOIN wp_posts img ON thumb.meta_value = img.ID
WHERE p.post_type = 'product'
AND p.post_status = 'publish'
GROUP BY p.ID, p.post_title, p.post_content, p.post_excerpt, p.post_name, p.post_date, p.post_modified, pm.meta_key, pm.meta_value, img.guid;
